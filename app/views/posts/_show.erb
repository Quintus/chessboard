<div class="post">
  <div class="post-author">
    <p class="author-name"><%= link_to post.author.nickname, url(:users, :show, post.author.nickname) %></p>
    <p class="author-membership"><%= post.author.membership %></p>
    <% if post.author.avatar_link %>
	<p class="author-avatar"><%= image_tag post.author.avatar_link, :alt => "User avatar" %></p>
    <% end %>
    <p class="author-registered">Registered: <%= post.author.created_at.strftime("%Y-%m-%d") %></p>
    <p class="author-posts">Posts: <%= post.author.posts.count %></p>
  </div>

  <div class="post-content">
    <div class="header post-header">
	<div class="post-created">
	  <p><%= I18n.l post.created_at, :format => :long %></p>
	</div>
	<div class="post-num">
	  <p><%= link_to "##{i + 1}", url(:topics, :show, post.topic.id) + "#p#{post.id}", :name => "p#{post.id}" %></p>
	</div>
    </div>

    <% if env["warden"].authenticated? %>
	<ul class="post-actions">
	  <% if !post.topic.locked? %>
	    <% if env["warden"].user.moderates?(post.topic.forum) %>
	      <li><%= link_to image_tag("icons/split.png") + "&nbsp;".html_safe + I18n.t("topics.split_here"), url(:topics, :split, post.topic.id) + "?post_id=#{post.id}" %></li>
	    <% end %>
	    <li><%= link_to image_tag("icons/report.png") + "&nbsp;".html_safe + I18n.t("reports.report_this"), url(:reports, :new) + "?post_id=#{post.id}" %></li>
	    <% if env["warden"].user.moderates?(post.topic.forum) || post.author == env["warden"].user %>
	      <li><%= link_to image_tag("icons/delete.png") + "&nbsp;".html_safe + I18n.t("posts.delete"), url(:posts, :destroy, post.topic.id, post.id) + "?authenticity_token=#{session[:csrf]}", :method => :delete, :confirm => I18n.t("general.are_you_sure") %></li>
	      <li><%= link_to image_tag("icons/edit.png") + "&nbsp;".html_safe + I18n.t("posts.edit"), url(:posts, :edit, post.topic.id, post.id) %></li>
	    <% end %>
	  <% end %>
	</ul>
    <% end %>

    <div class="post-text">
	<%= process_markup(post.content, post.markup_language) %>
	<% if env["warden"].authenticated? && env["warden"].user.privileged? %>
	  <p class="post-ip">
	    IP:
	    <% if post.ip.blank? %>
	      <%= I18n.t("posts.no_ip") %>
	    <% else %>
	      <%= post.ip %>
	    <% end %>
	  </p>
	<% end %>
	<div class="clear"><!-- Ensure all floating material ends with end of post --></div>
    </div>

    <% unless post.attachments.empty? %>
      <div class="post-attachments">
	<% post.attachments.order(:filename => :asc).each do |attachment| %>
	  <div class="post-attachment">
	    <p>
	      <strong><%= I18n.t("posts.attachment") %></strong> <%= link_to(attachment.filename, attachment.full_uri) %> (<%= File.size(attachment.full_path) %> Bytes)<br/>
	      <%= attachment.description.blank? ? I18n.t("posts.no_attachment_description") : simple_format(attachment.description) %>
	    </p>
	  </div>
	<% end %>
      </div>
    <% end %>

    <% if post.author.signature? %>
	<div class="signature post-signature">
	  <%= markup_default(post.author.signature).html_safe %>
	</div>
    <% end %>
  </div>
</div>
