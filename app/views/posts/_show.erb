<div class="topic">

  <div class="post">
    <div class="post-author">
      <p class="author-name"><%= link_to post.author.nickname, url(:users, :show, post.author.nickname) %></p>
      <p class="author-membership"><%= post.author.membership %></p>
      <% if post.author.avatar_link %>
	<p class="author-avatar"><%= image_tag post.author.avatar_link, :alt => "User avatar" %></p>
      <% end %>
      <p class="author-registered">Registered: <%= post.author.created_at.strftime("%Y-%m-%d") %></p>
      <p class="author-posts">Posts: <%= post.author.posts.count %></p>
    </div>

    <div class="post-content">
      <div class="header post-header">
	<div class="post-created">
	  <p><%= I18n.l post.created_at, :format => :long %></p>
	</div>
	<div class="post-num">
	  <p><%= link_to "##{i + 1}", url(:topics, :show, post.topic.id) + "#p#{post.id}", :name => "p#{post.id}" %></p>
	</div>
      </div>

      <% if env["warden"].authenticated? %>
	<ul class="post-actions">
	  <% if !post.topic.locked? %>
	    <% if env["warden"].user.moderates?(post.topic.forum) %>
	      <li><%= link_to image_tag("icons/split.png") + "&nbsp;".html_safe + I18n.t("topics.split_here"), url(:topics, :split, post.topic.id) + "?post_id=#{post.id}" %></li>
	    <% end %>
	    <li><%= link_to image_tag("icons/report.png") + "&nbsp;".html_safe + I18n.t("reports.report_this"), url(:reports, :new) + "?post_id=#{post.id}" %></li>
	    <% if env["warden"].user.moderates?(post.topic.forum) || post.author == env["warden"].user %>
	      <li><%= link_to image_tag("icons/delete.png") + "&nbsp;".html_safe + I18n.t("posts.delete"), url(:posts, :destroy, post.topic.id, post.id) + "?authenticity_token=#{session[:csrf]}", :method => :delete, :confirm => I18n.t("general.are_you_sure") %></li>
	      <li><%= link_to image_tag("icons/edit.png") + "&nbsp;".html_safe + I18n.t("posts.edit"), url(:posts, :edit, post.topic.id, post.id) %></li>
	    <% end %>
	  <% end %>
	</ul>
      <% end %>

      <div class="post-text">
	<%= process_markup(post.content, post.markup_language) %>
      </div>

      <% if post.author.signature? %>
	<div class="signature post-signature">
	  <%= markup_default(post.author.signature).html_safe %>
	</div>
      <% end %>
    </div>
  </div>
</div>

<%# Template should only be once in the code; only 0th entry is guaranteed to exist. %>
<% if i.zero? && env["warden"].authenticated? %>
<% user = env["warden"].user %>
<script id="post-template" type="text/x-handlebars-template">
  <div class="topic">

    <div class="post">
      <div class="post-author">
      <p class="author-name"><%= link_to user.nickname, url(:users, :show, user.nickname) %></p>
      <p class="author-membership"><%= user.membership %></p>
      <% if user.avatar_link %>
	<p class="author-avatar"><%= image_tag user.avatar_link, :alt => "User avatar" %></p>
      <% end %>
      <p class="author-registered">Registered: <%= user.created_at.strftime("%Y-%m-%d") %></p>
	<p class="author-posts">Posts: {{ post_count }}</p>
      </div>

      <div class="post-content">
	<div class="header post-header">
	  <div class="post-created">
	    <p>{{ post_created }}</p>
	  </div>
	  <div class="post-num">
	    <p><a href="{{ post_link }}" name="p{{ post_num }}">#{{ post_num }}</a></p>
	  </div>
	</div>

	<div class="post-text">
	  {{{ post_content }}}
	</div>
      </div>
    </div>
  </div>
</script>
<% end %>
